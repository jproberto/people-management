name: CI - Build and Test

on:
  push:
    branches: [ main, develop ]

jobs:
  test-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        
    - run: chmod +x ./mvnw
    
    - name: ğŸ§ª Run tests
      run: ./mvnw clean test
      
    - name: ğŸ—ï¸ Build JAR
      run: ./mvnw package -DskipTests
      
    - name: ğŸ³ Build Docker image
      run: |
        docker build -t people-management:${{ github.sha }} .
        docker build -t people-management:latest .
        
    - name: ğŸ“¦ Save Docker image
      run: docker save people-management:latest | gzip > people-management.tar.gz
      
    - name: ğŸ“¤ Upload Docker artifact
      uses: actions/upload-artifact@v3
      with:
        name: docker-image
        path: people-management.tar.gz

    - name: ğŸ“¢ Notify success
      if: success()
      run: echo "âœ… Build successful! JAR ready for deployment"

    - name: ğŸ“¢ Notify failure  
      if: failure()
      run: echo "âŒ Build failed! Check logs above"